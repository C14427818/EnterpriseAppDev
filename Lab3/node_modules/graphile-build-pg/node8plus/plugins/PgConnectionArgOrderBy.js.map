{"version":3,"sources":["../../src/plugins/PgConnectionArgOrderBy.js"],"names":["PgConnectionArgOrderBy","builder","pgInflection","inflection","hook","_","newWithHooks","pgIntrospectionResultsByKind","introspectionResultsByKind","graphql","GraphQLEnumType","class","filter","table","isSelectable","namespace","forEach","tableTypeName","tableType","name","orderByType","description","values","NATURAL","value","alias","specs","pgIntrospection","isPgRowSortEnum","args","extend","getTypeByName","pgGetGqlTypeByTypeId","pgSql","sql","GraphQLList","GraphQLNonNull","scope","isPgFieldConnection","pgFieldIntrospection","addArgDataGenerator","Self","field","kind","TableType","type","id","TableOrderByType","connectionOrderBy","orderBy","rawOrderBy","Array","isArray","pgCursorPrefix","some","item","map","literal","pgQuery","queryBuilder","unique","orders","length","col","ascending","expr","fragment","getTableAlias","identifier","setOrderIsUnique"],"mappings":"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","file":"PgConnectionArgOrderBy.js","sourcesContent":["// @flow\nimport isString from \"lodash/isString\";\nimport type { Plugin } from \"graphile-build\";\n\nexport default (function PgConnectionArgOrderBy(\n  builder,\n  { pgInflection: inflection }\n) {\n  builder.hook(\n    \"init\",\n    (\n      _,\n      {\n        newWithHooks,\n        pgIntrospectionResultsByKind: introspectionResultsByKind,\n        graphql: { GraphQLEnumType },\n      }\n    ) => {\n      introspectionResultsByKind.class\n        .filter(table => table.isSelectable)\n        .filter(table => !!table.namespace)\n        .forEach(table => {\n          const tableTypeName = inflection.tableType(\n            table.name,\n            table.namespace.name\n          );\n          /* const TableOrderByType = */\n          newWithHooks(\n            GraphQLEnumType,\n            {\n              name: inflection.orderByType(tableTypeName),\n              description: `Methods to use when ordering \\`${tableTypeName}\\`.`,\n              values: {\n                NATURAL: {\n                  value: {\n                    alias: null,\n                    specs: [],\n                  },\n                },\n              },\n            },\n            {\n              pgIntrospection: table,\n              isPgRowSortEnum: true,\n            }\n          );\n        });\n      return _;\n    }\n  );\n  builder.hook(\n    \"GraphQLObjectType:fields:field:args\",\n    (\n      args,\n      {\n        extend,\n        getTypeByName,\n        pgGetGqlTypeByTypeId,\n        pgSql: sql,\n        graphql: { GraphQLList, GraphQLNonNull },\n      },\n      {\n        scope: { isPgFieldConnection, pgFieldIntrospection: table },\n        addArgDataGenerator,\n        Self,\n        field,\n      }\n    ) => {\n      if (\n        !isPgFieldConnection ||\n        !table ||\n        table.kind !== \"class\" ||\n        !table.namespace ||\n        !table.isSelectable\n      ) {\n        return args;\n      }\n      const TableType = pgGetGqlTypeByTypeId(table.type.id);\n      const tableTypeName = TableType.name;\n      const TableOrderByType = getTypeByName(\n        inflection.orderByType(tableTypeName)\n      );\n\n      addArgDataGenerator(function connectionOrderBy({ orderBy: rawOrderBy }) {\n        const orderBy = rawOrderBy\n          ? Array.isArray(rawOrderBy) ? rawOrderBy : [rawOrderBy]\n          : null;\n        return {\n          pgCursorPrefix:\n            orderBy && orderBy.some(item => item.alias)\n              ? orderBy\n                  .filter(item => item.alias)\n                  .map(item => sql.literal(item.alias))\n              : null,\n          pgQuery: queryBuilder => {\n            if (orderBy != null) {\n              orderBy.forEach(item => {\n                const { specs, unique } = item;\n                const orders =\n                  Array.isArray(specs[0]) || specs.length === 0\n                    ? specs\n                    : [specs];\n                orders.forEach(([col, ascending]) => {\n                  const expr = isString(col)\n                    ? sql.fragment`${queryBuilder.getTableAlias()}.${sql.identifier(\n                        col\n                      )}`\n                    : col;\n                  queryBuilder.orderBy(expr, ascending);\n                });\n                if (unique) {\n                  queryBuilder.setOrderIsUnique();\n                }\n              });\n            }\n          },\n        };\n      });\n\n      return extend(\n        args,\n        {\n          orderBy: {\n            description: `The method to use when ordering \\`${tableTypeName}\\`.`,\n            type: new GraphQLList(new GraphQLNonNull(TableOrderByType)),\n          },\n        },\n        `Adding 'orderBy' to field '${field.name}' of '${Self.name}'`\n      );\n    }\n  );\n}: Plugin);\n"]}